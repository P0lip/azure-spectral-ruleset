extends: spectral:oas
functionsDir: './functions'
functions:
  - check-version
  - error-response
rules:
  info-contact: off
  openapi-tags: off
  operation-tag-defined: off
  operation-tags: off
  no-$ref-siblings: off
  oas2-unused-definition: off

  # https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md#172-casing
  ms-property-names-convention:
    message: "Property name is not lower camel case: {{property}}"
    severity: error
    # This rule can report false positives if run on the resolved spec.
    # Issue: https://github.com/stoplightio/spectral/issues/1316
    resolved: false
    given: $..[?(@.type === 'object' && @.properties)].properties.*~
    then:
      function: casing
      functionOptions:
        type: camel

  # All success responses except 202 & 204 should define a response body
  # ref: https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md#1321-put
  ms-success-response-body:
    description: All success responses except 202 & 204 should define a response body
    given: $.paths[*][*].responses[?(@property >= 200 && @property < 300 && @property != '202' && @property != '204')]
    severity: warn
    formats: ["oas2"]
    resolved: true
    then:
      field: schema
      function: truthy

  ms-success-response-nobody:
    description: Responses for status codes 202 and 204 should have no response body
    given: $.paths[*][*].responses[?(@property == '202' || @property == '204')]
    severity: warn
    formats: ["oas2"]
    resolved: true
    then:
      field: schema
      function: falsy

  ms-lro-headers:
    description: A 202 response should include an Operation-Location response header
    given: $.paths[*][*].responses[?(@property == '202')]
    severity: warn
    formats: ["oas2"]
    resolved: true
    then:
      field: headers.Operation-location
      function: truthy

  az-error-response:
    description: Verify that error response conforms to Microsoft Azure API Guidelines.
    message: "{{error}}"
    given: $.paths[*][*].responses
    severity: warn
    formats: ["oas2"]
    resolved: true
    then:
      function: error-response

  # Azure versioning policy is to use query parameter not path segment to specify version
  az-version-policy:
    description: Enforce the Azure versioning policy
    message: "{{error}}"
    formats: ["oas2"]
    given: $
    severity: warn
    then:
      function: check-version

